<div class="acciones mb-3 d-flex flex-wrap gap-2">
  <a routerLink="/productos" class="btn btn-outline-dark">Volver</a>
  <div class="d-flex align-items-center gap-2">
    <label class="form-label m-0">Umbral:</label>
    <input type="number" class="form-control form-control-sm" style="width:100px" [ngModel]="umbral()" (ngModelChange)="umbral.set($event)"/>
    <button class="btn btn-primary" (click)="buscar()" [disabled]="loading()">Buscar</button>
  </div>
  <button class="btn btn-success ms-auto" (click)="exportarExcel()" [disabled]="!data()">Exportar Excel</button>
  <button class="btn btn-secondary" (click)="imprimir()" [disabled]="!data()">Imprimir</button>
</div>

<div id="reporte-inventario-root" class="reporte-wrapper" *ngIf="data() as rep; else estado">
  <h2>Reporte Inventario</h2>
  <p class="text-muted">Generado: {{ rep.generadoEnUtc | date:'short':'UTC' }}</p>

  <div class="row g-3 resumen mb-4">
    <div class="col-6 col-md-4 col-lg-2" *ngFor="let card of [
      {t:'Productos Activos',v:rep.totalProductosActivos},
      {t:'Items en Stock',v:rep.totalItemsEnStock},
      {t:'Valor Costo',v:rep.valorTotalCosto | currency:'USD'},
      {t:'Valor Venta',v:rep.valorTotalVenta | currency:'USD'},
      {t:'Margen Potencial',v:rep.margenPotencial | currency:'USD'},
      {t:'Umbral Stock Bajo',v:rep.umbralStockBajo}
    ]">
      <div class="card p-2 small shadow-sm h-100">
        <div class="fw-bold">{{card.t}}</div>
        <div>{{card.v}}</div>
      </div>
    </div>
  </div>

  <div class="chart-container mb-4">
    <canvas #chartCanvas height="140"></canvas>
  </div>

  <h4>Productos con Stock Bajo ({{ rep.productosStockBajo.length }})</h4>
  <div class="table-responsive">
    <table class="table table-sm table-bordered align-middle">
      <thead>
        <tr>
          <th>CÃ³digo</th>
          <th>Nombre</th>
          <th>Stock</th>
          <th>Umbral</th>
          <th>Valor Inventario</th>
          <th>Precio Compra</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let p of rep.productosStockBajo">
          <td>{{ p.codigo }}</td>
            <td>{{ p.nombre }}</td>
            <td [class.text-danger]="p.stock < p.umbral">{{ p.stock }}</td>
            <td>{{ p.umbral }}</td>
            <td>{{ p.valorInventario | currency:'USD' }}</td>
            <td>{{ p.precioCompra | currency:'USD' }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
<ng-template #estado>
  <div *ngIf="loading()">Cargando...</div>
  <div *ngIf="!loading() && error()" class="alert alert-danger">{{ error() }}</div>
  <div *ngIf="!loading() && !error() && !data()" class="text-muted">Ingrese un umbral y presione Buscar.</div>
</ng-template>
